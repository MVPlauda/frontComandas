{% extends "base.html" %}
{% block title %}Produto{% endblock %}

{# ajusta a variáveis conforme novo ou edit #}
{% set id = result[0].id if result else '0' %}
{% set nome = result[0].nome if result else '' %}
{% set descricao = result[0].descricao if result else '' %}
{% set valor_unitario = result[0].valor_unitario if result else '' %}
{% set foto = result[0].foto if result else '' %}

{% block content %}
<form name="{{ 'formEditar' if result else 'formAdicionar' }}" id="{{ 'formEditar' if result else 'formAdicionar' }}"
    method="POST" enctype="multipart/form-data">
    <h1>Produto - {{ "%s: %s" % ('Editar Registro', id) if result else 'Novo' }}</h1>

    <!-- <div class="mb-3">
        <label for="codigo">Código</label>
    </div> -->

    <input type="text" class="form-control" id="id" readonly name="id" value="{{ id }}" hidden>

    <img src="{{ foto }}" class="w-25 img-fluid rounded-2" alt="">
    <div class="input-group mb-3">
        <input type="file" name="foto" class="form-control" id="foto" accept="image/*">
        <label class="input-group-text" for="foto">Upload</label>
    </div>

    <div class="mb-3">
        <label for="nome">Nome</label>
        <input type="text" class="form-control" value="{{ nome }}" id="nome" name="nome" required>
    </div>

    <div class="mb-3">
        <label for="preco">Preço</label>
        <input type="text" class="form-control" id="valor_unitario" name="valor_unitario" value="{{ valor_unitario }}"
            data-affixes-stay="true" data-prefix="R$ " data-thousands="." data-decimal="," required>
    </div>

    <div class="mb-3">
        <label for="descricao">Descrição</label>
        <textarea class="form-control" id="descricao" name="descricao"> {{ descricao }} </textarea>
    </div>



    <button class="btn btn-primary" type='submit' name='salvaProdutoDB' id='salvaProdutoDB'><i class='fas fa-save'></i>
        Salvar</button>
</form>
{% endblock %}

{% block js %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"
    integrity="sha512-pHVGpX7F/27yZ0ISY+VVjyULApbDlD0/X0rgGbTqCE7WFW5MezNTWG/dnhtbBuICzsd0WQPgpE4REBLv+UqChw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-maskmoney/3.0.2/jquery.maskMoney.min.js"
    integrity="sha512-Rdk63VC+1UYzGSgd3u2iadi0joUrcwX0IWp2rTh6KXFoAmgOjRS99Vynz1lJPT8dLjvo6JZOqpAHJyfCEZ5KoA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $(document).ready(function () {
        $('#valor_unitario').maskMoney();

        $SCRIPT_ROOT = {{ request.script_root | tojson | safe }}; // pega a url da barra de endereço
        // JS-Ajax para adicionar
        $('#formAdicionar').submit(function (e) {
            e.preventDefault(); // parar o envio para poder fazer manualmente
            var form = $('#formAdicionar')[0]; // captura o form
            var data = new FormData(form); // cria o FormData {Object}
            $.ajax({
                type: "POST", enctype: 'multipart/form-data', url: "{{url_for('produto.insert')}}", data: data,
                processData: false, // impedir que o jQuery transforme a "data" em querystring
                contentType: false, // desabilitar o cabeçalho "Content-Type"
                cache: false, // desabilitar o "cache"
                timeout: 600000, // definir um tempo limite (opcional)
                // manipular o retorno da requisição
                success: function (data) {
                    if (!data.erro) {
                        Swal.fire({
                            title: '', text: 'ID' + data.msg.id + ', ' + data.msg.msg, icon: 'success', showCancelButton: false, confirmButtonColor: '#3085d6',

                            cancelButtonColor: '#d33', confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.replace($SCRIPT_ROOT + "{{ url_for('produto.formListaProduto') }}");
                            }
                        });
                    }
                    else {
                        Swal.fire(data.msgErro.msg, data.msgErro.erro, "error");
                    }
                },
                // manipular erros da requisição
                error: function (e) {
                    console.log(e);
                }
            }) // fim execução ajax
        }) // fim função evento submit
        $('#formEditar').submit(function (e) {
            e.preventDefault(); // parar o envio para poder fazer manualmente
            var form = $('#formEditar')[0]; // captura o form
            var data = new FormData(form); // cria o FormData {Object}
            // caso queira adicionar campos extras ao FormData
            // data.append("customfield", "Este é um campo extra para teste");
            if ($('#foto').val() === '') {
                var foto = '{{ foto }}';
                data.append('foto_string', foto);
            }

            $.ajax({
                type: "POST", enctype: 'multipart/form-data', url: "{{url_for('produto.edit')}}", data: data,
                processData: false, // impedir que o jQuery tranforma a "data" em querystring
                contentType: false, // desabilitar o cabeçalho "Content-Type"
                cache: false, // desabilitar o "cache"
                timeout: 600000, // definir um tempo limite (opcional)
                // manipular o retorno da requisição
                success: function (data) {
                    if (!data.erro) {
                        Swal.fire({
                            title: '',
                            text: 'ID' + data.msg.id + ', ' + data.msg.msg, icon: 'success', showCancelButton: false, confirmButtonColor: '#3085d6',

                            cancelButtonColor: '#d33', confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.replace($SCRIPT_ROOT + "{{ url_for('produto.formListaProduto') }}");
                            }
                        })
                    }
                    else {
                        Swal.fire(data.msgErro.msg, data.msgErro.erro, "error");
                    }
                },
                // manipular erros da requisição
                error: function (e) {
                    console.log(e);
                }
            })
        })
    })
</script>
{% endblock %}
